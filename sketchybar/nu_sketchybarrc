#!/usr/bin/env nu

def to_args []: record -> string {
  $in
  | transpose key value
  | each {|x| $"($x.key)=($x.value)"}
  | str join " "
}

let itemDir: string = $env.XDG_CONFIG_HOME | path join "plugins"
let pluginDir: string = $env.XDG_CONFIG_HOME | path join "plugins"

const font = "HackGen Console NF"

const bar_color = "0x00000000"
const battery_color = "0xffb8bb26"
const battery_bg = "0x19b8bb26"
const white = "0xffffffff"

let bar = {
  position: top,
  color: $bar_color,
  height: 30,
  shadow: off,
  sticky: on,
  padding_right: 2,
  padding_left: 2,
  margin: 10,
  corner_radius: 5,
  topmost: window,
  blur_radius: 0,
  y_offset: 7,
} | to_args

sketchybar --bar $bar

let default = {
    padding_left: 7
    padding_right: 7
    icon.font: $"($font):Bold:17.0"
    label.font: $"($font):Bold:15.0"
    icon.color: $"($white)"
    label.color: $"($white)"
    icon.padding_left: 4
    icon.padding_right: 4
    label.padding_left: 4
    label.padding_right: 4
    background.height: 24
    background.corner_radius: 20
    background.border_width: 2
} | to_args

sketchybar --default $default

sketchybar --add event aerospace_workspace_change

let spaces = aerospace list-workspaces --all | lines

for sid in spaces {
  let space = $"space.($sid)"
  (
    sketchybar
      --add item $space left
      --subscribe $space aerospace_workspace_change
      --set $space
        background.color=0x44ffffff
        background.corner_radius=5
        background.height=20
        background.drawing=off
        label=$"($sid)"
        click_script=$"aerospace workspace ($sid)"
        script=$"($pluginDir | path join aerospace.nu) ($sid)"
  )
}

# (
#   sketchybar
#     --add item front_app left
#     --set front_app icon.drawing=off script=$"($pluginDir | path join front_app.nu)"
#     --subscribe front_app front_app_switched
# )

(
  sketchybar
    --add item battery right
    --set battery
      label.color=$battery_color
      label.shadow.drawing=off
      background.color=$battery_bg
      update_freq=120
      script=$"($pluginDir | path join battery.nu)"
    --subscribe battery system_woke power_source_change
)

sketchybar --update
